$schema: https://raw.githubusercontent.com/mhingston/keystone-cli/main/schemas/workflow.json
name: scaffold-feature
description: "Autonomously build new Keystone workflows and agents"

steps:
  - id: get_requirements
    type: human
    message: "Describe the workflow you want to build:"
    inputType: text

  - id: blueprint
    type: blueprint
    needs: [get_requirements]
    agent: keystone-architect
    prompt: |
      Generate a system blueprint for the following requirements:
      ${{ steps.get_requirements.output }}

  - id: plan
    type: workflow
    needs: [blueprint]
    path: scaffold-plan
    inputs:
      requirements: ${{ steps.get_requirements.output }}
      blueprint: ${{ steps.blueprint.output }}
    outputMapping:
      files: files

  - id: generate
    type: workflow
    needs: [blueprint, plan]
    path: scaffold-generate
    inputs:
      requirements: ${{ steps.get_requirements.output }}
      blueprint: ${{ steps.blueprint.output }}
      files: ${{ steps.plan.outputs.files }}
    outputMapping:
      files: files

  - id: validate_workflows
    type: shell
    needs: [generate]
    foreach: ${{ steps.generate.outputs.files.filter(f => f.path.endsWith('.yaml') && f.path.includes('workflows')) }}
    run: |
      echo "${{ item.content }}" | bun run src/cli.ts validate --stdin --type workflow
    allowFailure: true
    transform: |
      {
        path: item.path,
        content: item.content,
        valid: exitCode === 0,
        error: exitCode !== 0 ? stderr : null
      }

  - id: repair_workflows
    type: llm
    needs: [validate_workflows]
    foreach: ${{ steps.validate_workflows.output.filter(f => !f.valid) }}
    agent: software-engineer
    prompt: |
      A generated workflow file failed schema validation. Please fix it.

      File path: ${{ item.path }}
      
      Validation error:
      ${{ item.error }}

      Current content:
      ```yaml
      ${{ item.content }}
      ```

      The workflow schema requires:
      1. A top-level `name` field (string, required)
      2. A top-level `$schema` field pointing to: https://raw.githubusercontent.com/mhingston/keystone-cli/main/schemas/workflow.json
      3. A `steps` array with at least one step
      4. Each step must have `id` and `type` fields

      Return a JSON object with a single "content" field containing the corrected YAML as a string.
    outputSchema:
      type: object
      properties:
        content:
          type: string
          description: The fixed YAML content
      required: [content]

  - id: merge_files
    type: shell
    needs: [validate_workflows, repair_workflows]
    env:
      GENERATED: ${{ JSON.stringify(steps.generate.outputs.files) }}
      VALIDATED: ${{ JSON.stringify(steps.validate_workflows.output) }}
      REPAIRED: ${{ JSON.stringify(steps.repair_workflows.output) }}
    run: |
      bun -e '
      const generated = JSON.parse(process.env.GENERATED || "[]");
      const validated = JSON.parse(process.env.VALIDATED || "[]");
      const repaired = JSON.parse(process.env.REPAIRED || "[]");
      
      const repairedMap = new Map();
      if (Array.isArray(repaired)) {
        repaired.forEach((r, idx) => {
          const validatedItem = validated[idx];
          if (validatedItem) {
            repairedMap.set(validatedItem.path, r.content);
          }
        });
      }
      
      const final = generated.map(file => {
        if (repairedMap.has(file.path)) {
          return { ...file, content: repairedMap.get(file.path) };
        }
        return file;
      });
      
      console.log(JSON.stringify({ files: final }));
      '
    transform: |
      JSON.parse(stdout)

  - id: write_files
    type: file
    needs: [merge_files]
    foreach: ${{ steps.merge_files.output.files }}
    op: write
    path: ${{ item.path }}
    content: ${{ item.content }}

  - id: summary
    type: shell
    needs: [write_files]
    run: |
      echo "Scaffolding complete. Files created:"
      echo "${{ steps.generate.outputs && steps.generate.outputs.files ? steps.generate.outputs.files.map(f => f.path).join('\n') : '(dry run: no files generated)' }}"
